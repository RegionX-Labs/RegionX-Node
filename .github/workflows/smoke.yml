name: Smoke tests

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency: 
  group: ${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  block-production:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: Swatinem/rust-cache@v2
    - uses: ./.github/actions/setup

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Zombienet setup
      run: |
        wget https://github.com/paritytech/zombienet/releases/download/v1.3.100/zombienet-linux-x64
        chmod +x zombienet-linux-x64
        yes 2>/dev/null | ./zombienet-linux-x64 setup polkadot || true
        echo $GITHUB_WORKSPACE
        echo "PATH=$GITHUB_WORKSPACE:$PATH" >> $GITHUB_ENV
        echo $PATH

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.GH_TOKEN }}

    - name: Compile regionx-node
      run: |
        cargo build --release
        cp ./target/release/regionx-node .

    - name: Run smoke test 0001
      run: ./zombienet-linux-x64 -p native test ./zombienet_tests/0001-smoke-test.zndsl
